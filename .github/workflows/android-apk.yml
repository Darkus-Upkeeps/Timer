name: Build Android APK

on:
  workflow_dispatch:
  push:
    branches: ["main"]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Create Flutter project scaffold (if missing)
        run: flutter create --platforms=android --project-name work_timer .

      - name: Ensure Android INTERNET permission
        run: |
          python3 - <<'PY'
          from pathlib import Path
          p = Path('android/app/src/main/AndroidManifest.xml')
          s = p.read_text()
          perm = '<uses-permission android:name="android.permission.INTERNET"/>'
          if perm not in s:
            s = s.replace('<manifest xmlns:android="http://schemas.android.com/apk/res/android">',
                          '<manifest xmlns:android="http://schemas.android.com/apk/res/android">\n    ' + perm)
            p.write_text(s)
          PY

      - name: Decode keystore
        run: |
          if [ -z "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" ]; then
            echo "ANDROID_KEYSTORE_BASE64 is missing" >&2
            exit 1
          fi

          # Normalize accidental whitespace/newlines from pasted secrets.
          printf '%s' "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" \
            | tr -d '\r\n\t ' \
            | base64 -d > android/app/upload-keystore.jks

          if [ ! -s android/app/upload-keystore.jks ]; then
            echo "Decoded keystore is empty (invalid base64 secret)." >&2
            exit 1
          fi

          keytool -list -keystore android/app/upload-keystore.jks -storepass "${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" >/dev/null

      - name: Create key.properties
        run: |
          cat > android/key.properties <<EOF
          storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          storeFile=upload-keystore.jks
          EOF

      - name: Configure Android signing
        run: |
          python3 - <<'PY'
          from pathlib import Path

          kts = Path('android/app/build.gradle.kts')
          groovy = Path('android/app/build.gradle')

          if kts.exists():
              s = kts.read_text()
              if 'keyPropertiesFile' not in s:
                  s = s.replace(
                      'import java.util.Properties\n\nplugins {',
                      'import java.util.Properties\n\nval keyPropertiesFile = rootProject.file("key.properties")\nval keyProperties = Properties()\nif (keyPropertiesFile.exists()) {\n    keyProperties.load(keyPropertiesFile.inputStream())\n}\n\nplugins {'
                  )
              if 'create("release")' not in s:
                  s = s.replace(
                      'signingConfigs {\n        create("debug") {\n            storeFile = file("debug.keystore")\n            storePassword = "android"\n            keyAlias = "androiddebugkey"\n            keyPassword = "android"\n        }\n    }',
                      'signingConfigs {\n        create("debug") {\n            storeFile = file("debug.keystore")\n            storePassword = "android"\n            keyAlias = "androiddebugkey"\n            keyPassword = "android"\n        }\n        create("release") {\n            storeFile = file(keyProperties["storeFile"] as String)\n            storePassword = keyProperties["storePassword"] as String\n            keyAlias = keyProperties["keyAlias"] as String\n            keyPassword = keyProperties["keyPassword"] as String\n        }\n    }'
                  )
              s = s.replace(
                  'getByName("release") {\n            signingConfig = signingConfigs.getByName("debug")',
                  'getByName("release") {\n            signingConfig = signingConfigs.getByName("release")'
              )
              kts.write_text(s)
          elif groovy.exists():
              s = groovy.read_text()
              if 'keystorePropertiesFile' not in s:
                  s = s.replace(
                      'def localProperties = new Properties()',
                      'def keystoreProperties = new Properties()\ndef keystorePropertiesFile = rootProject.file(\'key.properties\')\nif (keystorePropertiesFile.exists()) {\n    keystoreProperties.load(new FileInputStream(keystorePropertiesFile))\n}\n\ndef localProperties = new Properties()'
                  )
              if 'signingConfigs {' in s and 'release {' not in s:
                  s = s.replace(
                      'buildTypes {',
                      'signingConfigs {\n        release {\n            keyAlias keystoreProperties[\'keyAlias\']\n            keyPassword keystoreProperties[\'keyPassword\']\n            storeFile keystoreProperties[\'storeFile\'] ? file(keystoreProperties[\'storeFile\']) : null\n            storePassword keystoreProperties[\'storePassword\']\n        }\n    }\n\n    buildTypes {'
                  )
              s = s.replace(
                  'release {\n            // TODO: Add your own signing config for the release build.\n            // Signing with the debug keys for now, so `flutter run --release` works.\n            signingConfig signingConfigs.debug',
                  'release {\n            signingConfig signingConfigs.release'
              )
              groovy.write_text(s)
          else:
              raise SystemExit('No Android Gradle file found')
          PY

      - name: Pub get
        run: flutter pub get

      - name: Build APK
        run: flutter build apk --release

      - name: Re-sign APK with stable keystore
        run: |
          APK_IN=build/app/outputs/flutter-apk/app-release.apk
          APK_OUT=build/app/outputs/flutter-apk/app-release-signed.apk
          APKSIGNER=$(find "$ANDROID_HOME/build-tools" -name apksigner | sort | tail -n1)
          "$APKSIGNER" sign \
            --ks android/app/upload-keystore.jks \
            --ks-key-alias "${{ secrets.ANDROID_KEY_ALIAS }}" \
            --ks-pass "pass:${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" \
            --key-pass "pass:${{ secrets.ANDROID_KEY_PASSWORD }}" \
            --out "$APK_OUT" \
            "$APK_IN"
          "$APKSIGNER" verify --print-certs "$APK_OUT"

      - name: Prepare release metadata
        id: prep
        run: |
          VERSION_LINE=$(grep '^version:' pubspec.yaml | head -n1 | awk '{print $2}')
          VERSION_NAME=${VERSION_LINE%%+*}
          VERSION_CODE=${VERSION_LINE##*+}
          CHANNEL="stable"
          TAG="latest-stable"
          RELEASE_NAME="Stable ${VERSION_NAME} (${VERSION_CODE})"
          PRERELEASE="false"

          SHA=$(sha256sum build/app/outputs/flutter-apk/app-release-signed.apk | awk '{print $1}')
          APK_NAME="work-timer-${CHANNEL}-${VERSION_CODE}.apk"
          cp build/app/outputs/flutter-apk/app-release-signed.apk "$APK_NAME"

          BODY=$(cat <<EOF
          {"versionName":"${VERSION_NAME}","versionCode":${VERSION_CODE},"channel":"${CHANNEL}","sha256":"${SHA}","notes":"Build from ${GITHUB_SHA}"}
          EOF
          )

          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "release_name=${RELEASE_NAME}" >> $GITHUB_OUTPUT
          echo "prerelease=${PRERELEASE}" >> $GITHUB_OUTPUT
          echo "apk_name=${APK_NAME}" >> $GITHUB_OUTPUT
          echo "body=${BODY}" >> $GITHUB_OUTPUT

      - name: Publish rolling release (channel latest)
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ steps.prep.outputs.tag }}
          name: ${{ steps.prep.outputs.release_name }}
          body: ${{ steps.prep.outputs.body }}
          commit: ${{ github.sha }}
          allowUpdates: true
          removeArtifacts: true
          replacesArtifacts: true
          prerelease: ${{ steps.prep.outputs.prerelease }}
          artifacts: ${{ steps.prep.outputs.apk_name }}

      - name: Upload APK artifact (CI backup)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.prep.outputs.apk_name }}
          path: ${{ steps.prep.outputs.apk_name }}
